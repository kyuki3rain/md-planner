# タスクインデックスコンポーネント詳細設計

## 1. 目的
- ワークスペース内のMarkdownからタスクを抽出し、ビュー向けに検索可能なインデックスを提供。
- 解析コストを抑えながら差分更新と再利用を実現。

## 2. コンポーネント構造
- `TaskIndexService`: パブリックAPI。クエリ、更新、購読機能を提供。
- `TaskScanner`: ファイルウォッチャと連携しMarkdownを解析。
- `TaskParser`: タスク行・属性ブロックをASTへ変換。
- `IndexStore`: インメモリでタスク情報を保持 (Map<taskId, TaskRecord>)。
- `FileMetadataStore`: ファイル単位のハッシュ、更新時刻、タスクID一覧を保持。
- `FrontmatterResolver`: スコープ設定を抽出しタスク属性へ適用。

## 3. データモデル
- `TaskRecord`: `{ id, title, bodyRange, fileUri, status, start, due, est, prio, assignee, project, tags, depends, repeat, progress, headings, rawAttributes }`
- `FileIndex`: `{ fileUri, version, taskIds: string[], defaults, boardConfig }`
- `QueryOptions`: `filters`, `range`, `sort`, `limit`, `groupBy`。

## 4. フロー
1. `TaskScanner`が初回クロール → 対象ファイルを列挙 (`include`/`exclude`設定に従う)。
2. 各ファイルに対し`TaskParser`がMarkdown ASTを生成 (marked + micromark拡張)。
3. チェックボックス行を検出し、属性ブロック・関数記法を解析 → `TaskRecord`作成。
4. `FrontmatterResolver`でスコープデフォルトをマージ。
5. `IndexStore`を更新。ファイル単位の差分で追加/削除を計算。
6. `TaskIndexService`が購読者へイベント (`added`, `updated`, `removed`) を発行。

## 5. API
```
interface TaskIndexService {
  initialize(workspaceFolders: Uri[]): Promise<void>;
  query(options: QueryOptions): Promise<TaskRecord[]>;
  getTaskById(id: string): TaskRecord | undefined;
  getTasksByScope(scope: ScopeSelector): TaskRecord[];
  refreshTask(id: string): Promise<TaskRecord | undefined>;
  on(event: 'change', listener: TaskIndexChangeListener): Disposable;
}
```
- `initialize`: ワークスペース監視と初期パースを開始。
- `query`: DSL解析結果を受け取りフィルタリング。`QueryEngine`と連携。
- `refreshTask`: 単一タスクの再パース (パッチ後に使用)。

## 6. 差分更新
- ファイルの`mtime`/`hash`を比較し未変更ならスキップ。
- ファイル更新時は既存タスクIDリストと再パース結果を比較。
- インデックス更新は`IndexTransaction`単位で行い、一貫性を保つ。

## 7. パフォーマンス/キャッシュ
- ASTキャッシュ: `lru-cache`で直近解析ファイルを保持。
- バックグラウンドワーカー: `worker_threads`で重いパースを別スレッドへ。
- デバウンス: ファイル監視イベントを200msデバウンス。

## 8. エラー処理
- パースエラー: `TaskParserError`として収集。Problemパネルへ報告。
- 字句解析に失敗した属性: `rawAttributes`に保持し、診断コンポーネントが処理。
- ファイルアクセス失敗: リトライ(3回)。それでも失敗ならユーザー通知。

## 9. テレメトリ/ログ
- ログレベル`debug`: 解析時間、タスク数を出力。
- テレメトリは既定OFF。設定で有効化時のみ収集。

## 10. テスト観点
- Markdown各種記法のユニットテスト (属性行、関数記法、フロントマター)。
- 巨大ファイル(>500行)のパフォーマンステスト。
- 差分更新: 追加/削除/更新ケースの自動テスト。
