# バリデーション・診断コンポーネント詳細設計

## 1. 目的
- タスク属性の整合性チェック、DSL検証、ユーザーへフィードバックを提供。
- VS CodeのDiagnostics APIを用いてリアルタイム警告/エラーを表示。

## 2. コンポーネント構造
- `ValidationEngine`: 各種検証ルールを実行するファサード。
- `RuleRegistry`: ルールの登録/管理。優先度、重大度を保持。
- `DiagnosticPublisher`: VS Code `DiagnosticCollection`への出力。
- `QuickFixProvider`: VS Code CodeActionProvider実装。修正案を生成。
- `DateExpressionEvaluator`: 相対日付/自然言語の解析。

## 3. 主なルール
- 日付整合性: `start <= due`, `due`が過去で完了していない場合警告。
- 推定工数: `est`フォーマット検証 (`Xm`, `Xh`, `Xd`)。
- 依存関係: 未知ID、循環参照検出。
- ID一意性: 重複IDを警告し最新更新を提示。
- DSL: 未知フィールド、演算子、未閉じ括弧。

## 4. ワークフロー
1. `TaskIndexService`または`PatchService`が変更を検知。
2. `ValidationEngine.run(taskRecords)`を実行。
3. 各ルールで`ValidationResult`を生成 (`severity`, `message`, `range`, `codeFixes`)。
4. `DiagnosticPublisher.publish(fileUri, diagnostics)`でVS Codeに反映。
5. `QuickFixProvider`がユーザー操作時に適用可能な修正を提示。

## 5. パフォーマンス
- 変更差分のみ検証するため、前回結果を`WeakMap<TaskId, ValidationHash>`でキャッシュ。
- 重いルール (依存循環) はワーカーにオフロードし、結果準備ができ次第診断を更新。

## 6. Quick Fix 例
- `due`欠落 → `Set due = start + est`。
- 未知ID依存 → `Remove dependency` or `Create placeholder task`。
- 重複ID → `Generate new ID`。

## 7. テスト観点
- 各ルールのユニットテスト (正/誤ケース)。
- 同期/非同期ルールの統合テスト。
- Quick Fix適用後のMarkdown差分検証。
