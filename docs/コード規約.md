# コード規約 (MDPlanner)

## 1. 設計原則
- Clean Architectureを基本とし、`domain`→`application`→`infrastructure`→`interface`の依存方向に統一。
- ドメイン層は純粋TypeScript (副作用禁止) とし、UI/VS Code API依存を持たない。
- コアユースケースはアプリケーション層のサービスとして定義し、副作用はポートインターフェース経由で抽象化。
- コンポーネントは小さな責務を維持し、SRP/ISPを遵守。

## 2. フォルダ構成指針 (仮)
```
src/
  domain/
    entities/
    value-objects/
    services/
    repositories/ (interfaces)
  application/
    usecases/
    dto/
    services/
  infrastructure/
    fs/
    vscode/
    parsers/
  interface/
    webview/
    extension/
    cli/
  shared/
    utils/
    types/
```
- `domain`配下は循環依存禁止。ユニットテストで100%スタブ化可能とする。
- `infrastructure`は外部API、ファイル、VS Code API、Webview通信などへの実装。
- `shared`はユーティリティ/型で、ビジネスロジックを含まないこと。

## 3. TypeScriptスタイル
- Strictモード必須 (`"strict": true`)。`noImplicitAny`, `noUnusedLocals` 等もON。
- 型は基本的に`type`を使用。複数の拡張が必要な場合のみ`interface`。
- `enum`禁止。ユニオン型/定数オブジェクトで代替。
- 非同期処理は`async/await`を使用し、Promiseチェーンは避ける。
- Optional値は`Option`型 (fp-ts) 等の導入を検討し、`null`/`undefined`の併用を避ける。
- エラーは`Result`型 (neverthrow) か例外のどちらを使用するかレイヤー毎に明示:
  - `domain`: 例外禁止。`neverthrow`の`Result`/`Option`を返却。
  - `application`: 例外を捕捉し、ドメインエラーへ変換。
  - `infrastructure`: 例外を投げても良いが即座に変換/ログ化。
  - Result/Optionの共有ヘルパは`@shared/result`から取得する。

## 4. 命名規則
- ファイル名: `kebab-case`。クラス/型: `PascalCase`。関数/変数: `camelCase`。
- インターフェース: `I`プレフィックスは付けず、`TaskRepository`のように役割で命名。
- DTO/Request/Responseは`UseCase`名 + `Input`/`Output`で統一。
- テストファイルは`.spec.ts` (ユニット) / `.test.ts` (統合) とし同階層に配置。

## 5. コーディングスタイル
- Biome (linter/formatter) を利用し、プロジェクトルートの`biome.json`でルールを管理。
- 行長: 100文字目安。テンプレートリテラルのインデントはBiome既定に従う。
- 早期returnを推奨。ネストを減らす。
- Side effectはファイル冒頭の依存注入箇所のみ許容。

### Import の位置と方式（追加ルール）
- import は原則としてファイル先頭（トップレベル）で一括して宣言してください。ファイルの途中での import（動的 import / import()）は最大限避け、明確な理由がある場合のみ許容します。
- 動的 import を許容する例外は下記に限定します。
  - 循環依存の解消がどうしても必要な場合
  - プラグインやオプション機能を遅延ロードする必要がある場合
  - 大容量ライブラリを初期ロードで読み込むと UX に悪影響がある場合
 例外を用いるときは、該当箇所にコメントで理由を明記し、影響範囲をコードレビューで説明してください。
- import の並び順はグループ化して整理することを推奨します（例: 外部依存 -> 社内共通(shared) -> 同レイヤー -> 相対パス）。各グループ内はアルファベット順で統一してください。自動整列用に `eslint-plugin-import` 等の導入を検討してください。
- Webview やランタイム固有の事情で動的ロードが必要なケースは例外として扱いますが、同様に理由の注記、ユニットテスト（ロード失敗時の挙動含む）、および手順書（docs）への記載を必須とします。

## 6. テスト指針
- TDDを徹底: インターフェース定義 → 失敗するユニットテスト → 実装 → リファクタ。
- ドメイン層はVitestを使用し、高速実行を最優先。
- アプリケーション層はモックを利用。インフラ層との統合は別途`integration`テストで検証。
- ユニットテスト命名: `describe('UseCaseName', ...)`、`it('should ...', ...)`。
- テストデータは`fixtures/`にFactoryを用意し、Builderパターンで可読性を担保。

## 7. ドキュメント/コメント
- 複雑なロジックは`/** */`のJSDocで振る舞いを記述。
- TODOは原則禁止。チケット化 or docsに記載。
- アーキテクチャ変更は`docs/ARCHITECTURE.md` (後日作成) に追記。

## 8. Lint/Format
- Linter/FormatterはBiomeを採用 (`biome check`, `biome format`)。
- `package.json`に`npm run lint`=`biome check --write=false`、`npm run format`=`biome format`を定義。
- コミット前に`lint`, `test`, `typecheck`をGit hooks (Husky) で実行予定。

## 9. 依存ポリシー
- ドメイン層では標準libと独自型以外の外部パッケージ禁止。
- アプリケーション層は軽量ライブラリのみ使用可 (例: `zod` for DTO validation)。
- インフラ層では必要なライブラリを採用可。導入時はdocsに理由を明記。

## 10. バリデーションとUIスタック
- 値オブジェクト/DTOのバリデーションは`zod` v4を第一候補とし、スキーマはドメイン層に配置。
- `neverthrow`と`zod`を組み合わせるユーティリティは`shared`レイヤーに置き、ドメイン層から再利用する。
- Webview UIは`tailwindcss` (最新版) と`shadcn/ui`を基本とし、PostCSS設定が不要なTailwind CLI運用を前提とする。
- Tailwindの設定は可能な限り`tailwind.config.ts`に集約し、必要に応じて`shadcn/ui`のプリセットを読み込む。

## 11. コードレビュー基準
- 変更影響範囲のテストが存在すること。
- Clean Architectureの境界が守られているか。
- インターフェース変更時は依存する全レイヤーを更新しドキュメントに反映。
