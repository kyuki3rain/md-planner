# 実装計画 (MDPlanner 初期イテレーション)

## 0. コンセプト
- 方針: **インターフェース定義 → ユニットテスト作成 → 実装 → リファクタ** のTDDサイクル。
- 範囲: まずはタスクインデックスとボードビューの最小ユースケース (タスク表示/追加/編集/削除) を対象。
- レイヤリング: Clean Architectureに沿って以下順に実装。
  1. `domain` (エンティティ/値オブジェクト/サービス)
  2. `application` (UseCase, DTO, ポートインターフェース)
  3. `infrastructure` (ファイル読取・Markdownパーサ・VS Code API)
  4. `interface` (Webview, Extension メッセージ)

## 1. スプリント0 (セットアップ)
1. TypeScript/Biome/Vitest の設定。
2. `src` フォルダ構成ひな型を作成。
3. テストランナーとCI (GitHub Actions想定) の最小設定。
4. 共通型 (`Result`, `Option`, `TaskId` etc.) の基盤実装。

## 2. ユースケース優先順位 (MVPロードマップ)
1. **タスクインデックス構築** ✅ (Iteration 1)
   - ファイル走査、タスクパース、インメモリインデックス。
   - 依存: Markdown属性パーサ、Frontmatter適用。
2. **タスクCRUDユースケース** ✅ (Iteration 2)
   - `CreateTask`, `UpdateTask`, `DeleteTask` UseCase。
   - `PatchService`によるMarkdown差分適用ポート。
3. **ボードビュー初期表示** ✅ (Iteration 3-5)
   - タスククエリ、列グループ化、Webviewメッセージプロトコル。
4. **Webviewタスク操作** ✅ (Iteration 4-5)
   - 追加/編集/削除アクションのUIイベント連携。
5. **リアルタイム更新** ✅ (Iteration 6)
   - ファイルウォッチャー、デバウンス処理。
6. **UI/UX改善** (Iteration 7) ← **次のステップ**
   - WebviewPanel（中央表示）への移行
   - Markdownファイル指定起動
   - アイコン改善
7. **バリデーション診断** (後続M1): 日付/依存の検証とDiagnostics連携。

## 3. 実装ステップ詳細
### 3.1 タスクインデックス (Iteration 1)
1. `domain/entities/task.ts` に `Task` エンティティ + 値オブジェクト (`TaskAttributes`, `TaskStatus`, `DueDate`) を定義。
2. `domain/services/task-factory.ts` にパース済みデータから`Task`を生成するファクトリ。
3. インターフェース:
   - `TaskRepository` (読み取り用)
   - `TaskIndexWriter` (差分登録)
4. テスト:
   - 値オブジェクトバリデーション (正常/異常)
   - ファクトリで属性をマージするケース
5. 実装:
   - `infrastructure/parsers/markdown-task-parser.ts`
   - `infrastructure/index/memory-task-repository.ts`

### 3.2 タスクCRUDユースケース (Iteration 2)
1. UseCaseインターフェース: `CreateTaskUseCase`, `UpdateTaskUseCase`, `DeleteTaskUseCase`。
2. 入出力DTOの定義 (`create-task.input.ts`, `create-task.output.ts` 等)。
3. テスト:
   - 成功/バリデーションエラー/競合時の挙動。
   - `TaskRepository`モックを利用。
4. 実装:
   - アプリケーション層で UseCase 実装。
   - `PatchServicePort` (外部) をモックし、副作用を抽象化。

### 3.3 ボードビュー (Iteration 3)
1. Webview用の`BoardViewModel`生成UseCase (`GetBoardColumnsUseCase`)。
2. インターフェース: `TaskQueryPort`。
3. テスト: グループ化、ソート、フィルタロジック。
4. 実装: `interface/webview/board/controller.ts` の骨組み。
5. WebviewとExtensionのメッセージシェル実装 (`task:create/delete/mutate`)。

### 3.4 Webviewタスク操作 (Iteration 4-5) ✅
1. `TaskEditorModal`状態管理 (Zustand store) の定義。
2. メッセージハンドラテスト (Playwrightは後回し、まずは`vitest`による通信モック)。
3. 実装: Reactコンポーネント、Bridgeフック (`useTaskEditor`)。

### 3.5 UI/UX改善 (Iteration 7)
**目的**: 実用性向上のための表示方式変更

**背景**:
- WebviewView（サイドバー）は狭すぎてカンバンボードに不適
- どのファイルのタスクを表示しているか不明確
- Markdown Previewのような直感的なUXが必要

**実装内容**:

1. **WebviewPanelへの移行**
   - `BoardViewPanel` クラス作成
   - `vscode.window.createWebviewPanel` で中央表示
   - ViewColumn.Active で現在のエディタグループに表示
   - 既存の`BoardViewProvider`は一旦残す（サイドバー用）

2. **Markdownファイル指定起動**
   - エディタタイトルバーにボタン追加 (`editor/title` menu)
   - コマンド: `md-planner.openBoardForCurrentFile`
   - アクティブなMarkdownファイルのパスを取得
   - 単一ファイルのみをパースしてボード表示

3. **package.json更新**
   ```json
   {
     "commands": [{
       "command": "md-planner.openBoardForCurrentFile",
       "title": "MD Planner: Open Board View",
       "icon": "$(kanban)"
     }],
     "menus": {
       "editor/title": [{
         "when": "resourceLangId == markdown",
         "command": "md-planner.openBoardForCurrentFile",
         "group": "navigation"
       }]
     }
   }
   ```

4. **単一ファイルパース機能**
   - `ParseSingleFileUseCase` 追加（オプション）
   - または既存の`BuildTaskIndexUseCase`を1ファイルで実行

5. **アイコン改善**
   - ダーク/ライトテーマ両対応の視認性の高いアイコン
   - カンバンボードをイメージしたデザイン

**テスト**:
- WebviewPanel作成のテスト
- Markdownファイルが開いていないときの警告表示
- 単一ファイルパースの動作確認

**参照資料**:
- [UI改善提案_ボードビュー表示方式.md](./UI改善提案_ボードビュー表示方式.md)

## 4. TDDワークフロー
1. 仕様またはドキュメントから責務を抽出。
2. インターフェース/型定義を作成 (`*.d.ts` ではなく通常の `*.ts` export)。
3. 失敗するユニットテスト (`vitest`) を先に実装。
4. ドメイン/アプリケーション層の実装を最小限で追加。
5. リファクタリングと共通化。
6. インフラ層実装 → インターフェーステスト。
7. Webview/拡張実装後にE2Eテストを計画。

## 5. リスクとチャレンジ
- Markdownパーサの実装コスト: `remark`/`micromark`採用を検討し、パフォーマンスを測定。
- Clean Architectureの境界が肥大化しがち → スコープを最小から追加。
- TDDによる初期コスト増 → テストテンプレートとFactoryの整備で軽減。

## 6. 次アクション
1. `package.json` とビルド設定を作成し、TypeScript/Vitest環境を用意。
2. `src/` 配下に層構造ディレクトリを作成。
3. ドメイン共通型 (`Result`, `TaskId`) のインターフェース定義とテストスケルトン作成。

---
本計画はピボット可能なLiving Documentとし、実装進行に合わせて更新する。
