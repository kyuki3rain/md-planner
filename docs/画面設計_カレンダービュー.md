# カレンダービュー詳細設計

## 1. ビュー概要
- 目的: タスクを月/週/日カレンダーへ投影し、期間編集や新規作成を直感的に行う。
- 表示モード: `month`, `week`, `day`。ヘッダーのタブで切替。
- データ: `start`, `due`, `repeat`, `assignee`, `project`。

## 2. レイアウト構成
```
┌──────────────────────────────────────────────┐
│ Header (mode switch, today button, range nav, filters) │
├──────────────────────────────────────────────┤
│ Calendar Grid (month/week/day responsive layout)        │
└──────────────────────────────────────────────┘
```
- Month: 7列×5-6行。タスクはバッジと詳細リストで表示。
- Week: 時間軸を縦に持つ7列カラム。ドラッグで時間範囲選択。
- Day: 1列の詳細タイムライン。30分刻み。

## 3. UIコンポーネント
- `CalendarView`: ルート。モード管理、データ取得、繰返し展開を担当。
- `CalendarHeader`: 期間移動、今日ボタン、フィルタ、ICSエクスポートアクション。
- `MonthGrid`: 月モード特化。日付セルコンポーネントを格子状に配置。
- `WeekGrid`: 週モード特化。時間スロットを生成。
- `DayTimeline`: 日モード特化。詳細時間表示。
- `CalendarCell`: 単一セル。`TaskBadge`のスタック、空セル操作のハンドリング。
- `TaskBadge`: 一件のタスクをバッジ表示。クリックで`TaskPopover`を開く。
- `TaskPopover`: 詳細編集フォーム（日付、タイトル、ステータス等）。
- `SelectionOverlay`: ドラッグ選択時の期間ハイライト。
- `TaskActionMenu`: バッジのコンテキストメニュー。編集、削除、複製、完了切替を提供。
- `DeleteConfirmDialog`: 削除時の確認モーダル。繰り返しタスクはシリーズ/単一選択を提供。

## 4. 状態管理
- `CalendarStore`: `currentMode`, `activeDate`, `visibleRange`, `filters`, `selectedTaskId`。
- `recurrenceCache`: `repeat`付きタスクを期間内に展開するキャッシュ。
- イベント: `onModeChange`, `onDateNavigate`, `onRangeSelect`, `onTaskDrop`, `onTaskCreate`。

## 5. データバインディング
- 期間内タスクの取得: `TaskIndexService.query({between: visibleRange})`。
- 繰り返し (`repeat`): iCal RRULEをライブラリ(`rrule`)で展開。展開結果は仮想IDで表示。
- バッジ色: `status`+`prio`で決定。完了はストライクトーン。
- ドラッグ移動: 週/日モードでは`start/due`を時間粒度で再計算。

## 6. インタラクションフロー
1. セルをドラッグ選択 → `SelectionOverlay`が範囲を表示。
2. ドロップで`New Task`モーダルを表示。タイトル/日付を初期値設定。
3. 既存タスクをドラッグ → `onTaskDrop`で開始/終了日時を更新。
4. `repeat`タスクを編集すると例外処理ダイアログで「この発生のみ/シリーズ全体」を選択。
5. ICSエクスポート: 現在のフィルタ結果を`ics`ファイルとして生成し保存ダイアログを開く。
6. `TaskBadge`クリックで`TaskPopover`を編集モードとして開く。保存時に`applyTaskMutation`で属性を更新し、必要に応じて繰り返し例外を作成。
7. `TaskActionMenu`の`削除`を選ぶと`DeleteConfirmDialog`を表示。単発/シリーズ削除を選択後`PatchService.deleteTask`を実行し、対象バッジをアニメーションで除去。

## 7. 状態別UI
- 完了タスク: 半透明。週/日モードでは下部に移動。
- 期限切れ: 赤枠で表示、日付セルに警告ドット。
- ブロック: バッジ左側に警告アイコン。

## 8. アクセシビリティ
- キーボード移動: `HJKL`または矢印キーで日付移動、`Enter`でタスク作成。
- ARIA: グリッドとして宣言し、セルに`aria-label`で日付とタスク数を読み上げ。
- モード切替はタブ可能。フォーカス状態を明示的に描画。

## 9. エラー/ローディング
- データ取得中はセルにスケルトンバー。
- 繰返し展開失敗時: 例外ログ + トースト。セルには「RRULEエラー」タグ。
- インデックス同期中: ヘッダーにスピナー。

## 10. 拡張ポイント
- リソースビュー: `assignee`別に列を分ける追加モードの余白を確保。
- 外部カレンダーインポート: ICSファイルをドラッグして取り込む領域をヘッダーに追加予定。

## 11. タスク操作UX
- 追加: 月モードではセルの`+`ボタン、週/日モードではドラッグ範囲選択で新規タスクモーダルを開く。既定で`start`=`visibleRange.start`、`due`=`start + duration`を設定。
- 編集: `TaskPopover`で日付、ステータス、担当を更新。繰り返しタスクの場合は例外扱い/シリーズ更新を切り替えるラジオボタンを表示。
- 削除: `TaskActionMenu`もしくは`TaskPopover`から削除。繰り返しタスクは単発削除で`EXDATE`を追加、シリーズ削除で元タスクを除去。
