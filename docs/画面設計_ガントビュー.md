# ガントビュー詳細設計

## 1. ビュー概要
- 目的: タスクの開始・終了日、依存をバーで視覚化し工数/スケジュール調整を支援。
- 対応データ: `start`, `due`, `est`, `depends`, `project`, `assignee`。
- レンダリング: SVGベース (d3-scale + custom renderer) でズーム/パンを実装。

## 2. レイアウト構成
```
┌─────────────────────────────────────────────┐
│ Header (Zoom, View Range, Grouping, Filter) │
├─────────────────────────────────────────────┤
│ Timeline Axis                               │
├───────────────┬─────────────────────────────┤
│ Task Tree     │ Gantt Canvas (Virtual Rows) │
└───────────────┴─────────────────────────────┘
```
- Header: ズームボタン(日/週/月)、期間ピッカー、グループ選択(プロジェクト/フォルダ)。
- Task Tree: 行ラベル領域。タスク名、プロジェクト、担当、チェックボックス。
- Gantt Canvas: 横軸に期間を持つバー描画。スクロール同期。

## 3. UIコンポーネント
- `GanttView`: ルート。ビューポートとズーム、パン状態を保持。
- `GanttHeader`: レンジ選択、ズーム、フィルタ。日付レンジ変更でインデックスへクエリ。
- `GanttTaskTree`: 折りたたみ可能な階層リスト。Markdownのヘッダ階層または`project`でグループ化。
- `GanttCanvas`: SVG要素を制御。バー、マイルストーン、依存線を描画。
- `GanttBar`: 単一タスクのバー。進捗や期限アラートを視覚化。
- `DependencyLink`: `depends`を表現する矢印。ライン描画のためにBézier経路を生成。
- `InlineEditor`: バーをドラッグ時に表示されるポップオーバー。日付/工数の微調整フォーム。
- `TaskEditorDrawer`: タスクの詳細編集用サイドドロワー。バークリックで開く。
- `TaskCreateButton`: ヘッダーに配置。空行または選択行を初期値として新規タスクを起票。
- `TaskContextMenu`: バー／ツリーノード右クリックで開くメニュー。編集・削除・複製を提供。

## 4. 状態管理
- `GanttStore`: ズーム倍率、表示期間 (`viewStart`, `viewEnd`)、行の展開状態、選択タスク。
- イベント: `onZoomChange`, `onViewportScroll`, `onBarResize`, `onBarMove`, `onDependencyHover`。
- Redux風アクションを`zustand`または`redux-toolkit`で実装。

## 5. データバインディング
- インデックスから`TaskDetail`を取得し、`start`または`due`欠落時は推測ルール: `start`無→`due-est`、`due`無→`start+est`。
- グループ化設定: Frontmatter `gantt.groupBy` > ユーザー設定 > 既定(`project`)。
- バー色: `status`に対応(doing=青, blocked=赤, done=緑, todo=灰)。
- 進捗表示: `progress`または`status`完了比率で内部塗りつぶし。

## 6. インタラクションフロー
1. 行スクロールとキャンバススクロールを同期。`scrollLeft`でタイムライン軸も更新。
2. バードラッグ(横移動): `onBarMove` → 相対日数を計算 → `PatchService`に`start/due`更新要求。
3. バー端ドラッグ(リサイズ): `onBarResize` → 新しい期間を検証 (`start <= due`)。
4. 依存リンクホバー: ツールチップで依存元/先の情報と遅延警告。
5. マイルストーン(期間=0)はダイヤ形で描画し、クリックで編集ダイアログ。
6. `TaskCreateButton`押下または空行ダブルクリックで`TaskEditorDrawer`を新規モードで開き、開始日/終了日を初期化後`PatchService.createTask`を呼び出しバーを挿入。
7. `GanttBar`クリックで`TaskEditorDrawer`を編集モードとして開く。保存時に`applyTaskMutation`をチェーンし、完了後に`refreshTask`を実行。
8. `TaskContextMenu`の`削除`選択で確認ダイアログ → `PatchService.deleteTask`を実行し、バーとツリー項目をアニメーション付きで除去。

## 7. 状態別UI
- 過去日付: `viewEnd < today` のバーは彩度を落とす。
- クリティカルパス(将来拡張): オプションで太線表示。現状は`depends`列.
- リソース競合: 同一担当の重複期間がある場合、バー上にストライプパターン。

## 8. アクセシビリティ
- タイムライン軸をスクリーンリーダーへ提供するため、ダイジェストテーブルをARIAで隠しテキストとして用意。
- キーボード操作: `Tab`でタスク行 → `Enter`で編集ダイアログ。
- 高コントラストテーマでパターンテクスチャを併用。

## 9. エラー/ローディング
- 日付欠損時: バーを点線で表示し、クリックで日付入力を促すモーダル。
- パッチ失敗: 元の開始/終了日に自動復元しToastで通知。
- 大量データ(>500タスク)時: ローディングプレースホルダと仮想化関数で分割フェッチ。

## 10. 拡張ポイント
- プロジェクトマーカー: 範囲背景色でプロジェクトをハイライト。
- バッファ/スラック表示: `float`フィールド対応時にバー後方へ淡色エリア。

## 11. タスク操作UX
- 追加: ヘッダーの`TaskCreateButton`または空白行のコンテキストメニューから新規タスクを起票。開始日/終了日は現在のビュー範囲内に収まるよう自動提案し、既存タスクとの依存を選択可。
- 編集: バークリックで右側ドロワーを開き、期日・担当・依存関係を編集。変更中はバーをプレビューレイヤーで反映。
- 削除: バー/行コンテキストメニュー経由で削除。確認ダイアログで依存タスクへの影響をリスト表示し、必要なら依存解除オプションを提示。
