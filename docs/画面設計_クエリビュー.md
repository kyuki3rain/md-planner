# クエリビュー詳細設計

## 1. ビュー概要
- 目的: DSLによるフィルタ、保存クエリ、結果一覧/カード表示を提供。
- ビュー種別: サイドバー常駐の`QueryPanel` + Webviewの結果領域。
- 対応DSL: `field:value`, 比較演算子、論理演算、日付式。

## 2. レイアウト構成
```
┌─────────────────────────────────────────────────┐
│ Header (query input, saved query dropdown, run button) │
├─────────────────────────────────────────────────┤
│ Filter Chips                                      │
├─────────────────────────────────────────────────┤
│ Result Toolbar (view toggle, sort, export)        │
├─────────────────────────────────────────────────┤
│ Result Area (list or board-like grouping)         │
└─────────────────────────────────────────────────┘
```
- Header: クエリ入力フィールド、保存ボタン、クエリ候補。
- Filter Chips: 現在有効なフィルタをタグ表示し、クリックで削除。
- Result Toolbar:リスト表示/カード表示切替、ソート、CSV出力。
- Result Area: `ListView`(テーブル)と`CardView`(カードグリッド)を切替。

## 3. UIコンポーネント
- `QueryView`: ルート。DSL解析、結果取得、保存クエリ管理。
- `QueryInput`: Monacoエディタを埋め込み。DSLのシンタックスハイライト、補完。
- `SavedQueryDropdown`: ユーザー保存クエリを一覧表示。選択で即適用。
- `FilterChipList`: DSLを解析して個別フィルタを視覚化。
- `ResultToolbar`: ソート基準、表示形式、エクスポート操作。
- `TaskListTable`: タスクをテーブル形式で表示。列: タイトル、プロジェクト、期限、担当、ステータス。
- `TaskCardGrid`: カード形式。レスポンシブグリッドで期日バッジを表示。
- `TaskResultActionBar`: 選択タスクに対する編集/削除/完了切替ボタンを提供。
- `TaskEditorModal`: 選択タスクの編集、新規作成に利用。テンプレート選択およびプレビューを含む。
- `EmptyResult`: ノーマッチ時にヒントを提示。

## 4. 状態管理
- `QueryStore`: `currentQuery`, `parsedFilters`, `result`, `viewMode`, `sortKey`, `isRunning`。
- クエリ実行: `DSLParser.parse` → `TaskIndexService.query(parsed)`。
- 保存クエリ: `SavedQueryRepository` (設定ファイル or `globalState`) にCRUD。

## 5. データバインディング
- DSL解析結果を`parsedFilters`に保持し、Chip表示とクエリ再実行に利用。
- 結果は`TaskSummary`の配列。テーブル/カードにバインド。
- 色やアイコン: `status`→カラーコード、`prio`→アイコン。

## 6. インタラクションフロー
1. 入力時: `QueryInput`が補完候補 (フィールド、演算子、値) を提示。
2. `Run`ボタン押下または`Ctrl+Enter`でクエリ実行。`isRunning`をtrue。
3. 成功: 結果リストを更新、`isRunning=false`。Chipリストを表示。
4. Chip削除: 対応するDSL要素を除外し再実行。
5. 保存: ユーザーが名前を入力。既存重複時は上書き確認ダイアログ。
6. クエリ共有 (M+): JSON形式でクリップボードコピー。
7. `ResultToolbar`の`新規タスク`ボタンで`TaskEditorModal`を新規モードで開き、指定クエリ条件を初期値として`PatchService.createTask`を実行。
8. リスト/カード選択後、`TaskResultActionBar`の`編集`でモーダルを開き、保存時に`applyTaskMutation`で対象タスクを更新。
9. `TaskResultActionBar`の`削除`またはキーボード`Del`で確認ダイアログを表示し、承認後`PatchService.deleteTask`を呼び出して結果から除外。

## 7. 状態別UI
- エラー: DSL解析失敗時に入力下へエラーバナー。該当位置をハイライト。
- 実行中: Headerにプログレスバー。`Run`ボタンをスピナーに。
- 大量データ (>500件): 無限スクロール、ページングインジケータ。

## 8. アクセシビリティ
- Monaco利用時: スクリーンリーダーモードをONにする設定エントリ。
- テーブルは`role="table"`でヘッダーに`scope`属性。
- キーボードショートカット: `Ctrl+Enter`実行、`Ctrl+S`保存、`Ctrl+Shift+S`別名保存。

## 9. エラー/ローディング
- DSLパース例外: 詳細メッセージと修正候補 (例: 未閉じ括弧)。
- インデックス未初期化: リザルトエリアにセットアップ案内ボタン。

## 10. 拡張ポイント
- 高度な可視化 (バーンダウン等) のプレースホルダをResult Toolbarに確保。
- クエリ履歴タブ: 直近実行クエリを時系列で参照できるアコーディオン。

## 11. タスク操作UX
- 追加: クエリ条件を初期値として新規タスク作成。例: `project:alpha`で絞り込んだ状態なら`project`をプリセット。
- 編集: 複数選択時はモーダルで一括編集フィールド (ステータス、担当) を表示し、未入力項目は個別編集にフォールバック。
- 削除: 複数選択を許可。削除確認で影響範囲 (ファイル名、ID) を一覧し、Undoリンクをトーストに表示。
