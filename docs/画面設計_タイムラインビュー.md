# タイムラインビュー詳細設計

## 1. ビュー概要
- 目的: 期限・開始日の密集度と重なりをレーン表示で俯瞰し調整。
- 表示スタイル: タスクをレーン(担当/プロジェクト)にマッピングし、期間を帯、期限をポインタで表示。
- データ取得: `TaskIndexService.query`でフィルタ済みタスクを取得。

## 2. レイアウト構成
```
┌─────────────────────────────────────────┐
│ Header (range selector, lane grouping, filters) │
├─────────────────────────────────────────┤
│ Timeline Axis (horizontal)                        │
├───────────────┬───────────────────────────┤
│ Lane Labels    │ Lane Canvas (virtual rows)        │
└───────────────┴───────────────────────────┘
```
- Header: 期間プリセット(1週/2週/1ヶ月)、グループ選択(`assignee`, `project`, `status`)。
- Axis: 日付刻み。ズームに応じて日/週単位でメモリを調整。
- Lane: 各レーンにタスク区間を帯で表示。オーバーラップ強調。

## 3. UIコンポーネント
- `TimelineView`: ルート。ビュー範囲、フィルタ状態、ハイライト対象を保持。
- `TimelineHeader`: 範囲変更、グループ選択、フィルタクイック検索。
- `LaneList`: レーン構造を生成。スクロール同期用のリファレンスを保持。
- `LaneRow`: 単一レーン。レーン名、タスク数、ヒートマップを表示。
- `TimelineBand`: `start`〜`due`を帯として描画。相対位置はスケール計算。
- `DeadlineMarker`: `due`のみのタスクをマーカーとして表示。
- `OverlapIndicator`: 重なり検出に基づく警告アイコン。
- `QuickAddButton`: レーンヘッダーに配置する追加ボタン。選択レーンを初期値に新規タスクを作成。
- `TaskEditorModal`: 追加・編集兼用のモーダル。期間、優先度、タグを編集。
- `LaneContextMenu`: レーン/帯右クリックで編集・削除・複製を提供。

## 4. 状態管理
- `TimelineStore`で`viewStart`, `viewEnd`, `groupBy`, `activeFilters`, `hoverTaskId`を保持。
- フィルタ変更時は`TaskIndexService.query()`を再実行し結果キャッシュを更新。
- ユーザー操作からのイベント: `onBandDrag`, `onBandResize`, `onMarkerClick`, `onFilterApply`。

## 5. データバインディング
- レーンキーは`groupBy`指定。`assignee`が空の場合は`@unassigned`。
- 期間: `start`が無い場合`due-1d`で帯化。`due`が無い場合は`start`のみマーカー化。
- 帯の色: `prio`に応じて(例: P0=赤, P1=橙, P2=青, P3=灰)。
- ツールチップ: タスクタイトル、`due`, `est`, 依存タスク、進捗。

## 6. インタラクションフロー
1. レーンスクロール: `LaneList`と`LaneCanvas`の垂直スクロールを同期。
2. 帯ドラッグ: `onBandDrag`で`start/due`更新を計算。`PatchService`に差分適用。
3. 帯リサイズ: `onBandResize` → 入力検証 → 成功時に即再描画。
4. マーカークリック: クイック編集ポップアップ (`due`, `status`)。
5. オーバーラップ強調: 同レーンで期間が重なると`OverlapIndicator`を表示。
6. `QuickAddButton`または空きスロットダブルクリックで`TaskEditorModal`を新規モードとして開き、レーン属性を初期値として`PatchService.createTask`を実行。
7. `TimelineBand`/`DeadlineMarker`クリックで`TaskEditorModal`を編集モードで開き、保存時は`applyTaskMutation`で期間・属性を更新。
8. `LaneContextMenu`の`削除`で確認ダイアログ → `PatchService.deleteTask`を呼び出し、該当帯/マーカーをフェードアウトして除去。

## 7. 状態別UI
- 期限切迫 (`due<=today+2d` & 未完了): 帯に赤の枠線。
- ブロックタスク: 左端に警告アイコン + ツールチップで依存先。
- 完了タスク: 半透明表示、選択時のみ詳細を表示。

## 8. アクセシビリティ
- レーンは`role="list"`、帯は`role="listitem"`で読み上げ。
- ズーム/レンジ変更はショートカット(`Ctrl+`/`Ctrl-`)を提供。
- ハイコントラストモードでは色に頼らないアイコン表示を追加。

## 9. エラー/ローディング
- データ取得中はレーン毎のローディングバー。
- 更新衝突時は最新データで再描画し、ユーザーに差分を提示。

## 10. 拡張ポイント
- レーンごとの目標線(例: 稼働時間上限)を表示可能な余白を確保。
- ヒートマップ: 期日密度を背景グラデーションで表示する実験フラグ。

## 11. タスク操作UX
- 追加: レーンヘッダーの`QuickAddButton`で担当者/プロジェクトを自動適用し、必要に応じて`TaskEditorModal`で詳細設定。ショートカット`Shift+N`で現在フォーカス中レーンの追加モーダルを開く。
- 編集: バンドクリックでモーダルを開き、プレビューで重なり度合を表示。保存時に重複解消提案を提示。
- 削除: レーン/帯コンテキストメニューから削除。依存するタスクがある場合は警告と代替操作 (ブロック状態に変更) を案内。
