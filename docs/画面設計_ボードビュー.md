# ボードビュー詳細設計

## 1. ビュー概要
- 目的: Markdownタスクの`status`または任意フィールドに基づいたカンバン表示とドラッグ操作による状態更新。
- 初期表示: デフォルトは`status`列。ユーザー設定/Frontmatterで列定義を切り替え。
- データソース: タスクインデックスAPI (`TaskIndexService.getTasksByScope`)。

## 2. レイアウト構成
```
┌──────────────────────────────────────────────────────────────┐
│ Header                                                       │
├───────────────┬───────────────┬───────────────┬───────────────┤
│ Column Header │ Column Header │ Column Header │ Column Header │
├───────────────┼───────────────┼───────────────┼───────────────┤
│ Kanban Column │ Kanban Column │ Kanban Column │ Kanban Column │
│ (Virtual List)│ (Virtual List)│ (Virtual List)│ (Virtual List)│
└───────────────┴───────────────┴───────────────┴───────────────┘
```
- Header: ビュー切替、ソート/フィルタ、検索ボックス。
- Column Header: 列名、タスク数、進捗率、列設定メニュー。
- Column Body: 仮想化リストでカードを縦に表示。DnDターゲット。

## 3. UIコンポーネント
- `BoardView`: ルートReactコンテナ。列データのロードとDnDコンテキストを提供。
- `BoardHeader`: ビュー共通ヘッダー。フィルタ入力、グローバルクイックアクションを提供。
- `BoardColumn`: 単一列のラッパー。列設定メニュー、メタ情報表示。
- `TaskCard`: タスクの概要カード。タイトル、ステータス、期日、担当、タグ、進捗バーを描画。
- `CardQuickActions`: `TaskCard`内のボタン群 (完了、ブロック、期日+1日、編集)。
- `ColumnAddMenu`: 新規タスク追加のインラインフォーム。
- `TaskEditorModal`: 追加/編集用モーダル。タイトル・属性フォームとプレビューを提供。
- `TaskContextMenu`: カード右クリックで開く文脈メニュー。編集/削除/複製を提示。
- `EmptyState`: 該当タスクが無い場合にヘルプコピーを表示。

## 4. 状態管理
- グローバル状態: `BoardStore` (zustand想定) で列定義、フィルタ、DnDの一時状態を保持。
- プロパティ: `columns`, `groupBy`, `filterPredicate`, `selectedTaskId`, `isLoading`。
- イベントハンドラ: `onCardDrop`, `onCardSelect`, `onFilterChange`, `onColumnConfigSave`。
- 変更時は`PatchService.applyTaskMutation`を呼び出しMarkdownへ反映。

## 5. データバインディング
- 初回ロード: インデックスから`TaskSummary`を列グループ化。
- 列順序: Frontmatter `board.columns` > ユーザー設定 > 既定 `[todo, doing, blocked, done]`。
- カード表示情報: タスクID、タイトル、`due`, `assignee`, `est`, `progress`, `tags`。
- 進捗率: `progress`が無い場合は`status`に応じた既定色のみ表示。

## 6. インタラクションフロー
1. ユーザーがカードをドラッグ → `BoardDnDContext`が`dragStart`イベントを発火。
2. ドロップ先列で`onCardDrop` → `MarkboardCommandQueue.enqueue`に差分要求を送信。
3. `PatchService`が対象Markdownへステータス変更パッチを適用。
4. 成功後、`TaskIndexService.refreshTask(id)`で単一タスクを再解析。
5. UIは`BoardStore`を更新し列のカウントとカード位置を再計算。
6. `ColumnAddMenu`から新規タスクを作成 → `TaskEditorModal`で詳細入力 → `PatchService.createTask`を実行し、完了後に対象列へカードを挿入。
7. `TaskCard`の`編集`アクションまたはダブルクリックで`TaskEditorModal`を開き、編集結果を`applyTaskMutation`に連携。
8. `TaskContextMenu`の`削除`選択で確認ダイアログを表示 → `PatchService.deleteTask`を呼び出し、インデックス更新完了後にカードをリストから除去。

## 7. 状態別UI
- `status=done`: カード背景を淡い緑、完了チェックアイコンを表示。
- 期限切れ (`due < today` + 未完了): カードヘッダーに赤いバッジ、列ヘッダーに警告数。
- ブロック (`status=blocked`): 左縁に赤ライン、ツールチップで依存関係を表示。

## 8. アクセシビリティ
- キーボードDnDサポート: 矢印で列移動、`Enter`でドロップ。
- ARIAロール: Columnを`list`, Cardを`listitem`として発声順を制御。
- コントラスト: テキスト対背景コントラスト比 4.5:1 を満たすカラーパレット。

## 9. エラー/ローディング
- ローディング: 列ごとにスケルトントラックを表示。
- パッチ失敗時: トースト通知 + カードを元の列へリバート。
- インデックス更新中: ヘッダーに「同期中」インジケータを表示。

## 10. 拡張ポイント
- 列単位のサブグループ (例: 担当者) 表示をM1以降で差し込み。
- WIP制限: `board.columns`に`wipLimit`を追加した場合のバッジ表示を許容。

## 11. タスク操作UX
- 追加: `ColumnAddMenu`は最小入力 (タイトル、担当、期日) を受け取り、`TaskEditorModal`で詳細を拡張。キーボードショートカット`N`で直近列の追加モーダルを開く。
- 編集: `TaskCard`ダブルクリックまたはカード内`編集`ボタンでモーダルを開き、ライブプレビューと属性バリデーションを表示。適用後は`applyTaskMutation`を一括実行。
- 削除: `TaskContextMenu`→`削除`。確認ダイアログで`Undo`リンクを提供し、数秒以内なら`PatchService`の逆操作で復元。
